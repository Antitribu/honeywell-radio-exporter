[tox]
envlist = py311,py312,lint,format-check,markdown,yaml
isolated_build = True
skip_missing_interpreters = True

[testenv]
description = Run pytest tests with coverage
deps =
    pytest>=7.0
    pytest-cov>=4.0
    pytest-asyncio>=0.21.0
    prometheus-client>=0.17.0
extras = test
commands =
    pytest tests/ --cov=honeywell_radio_exporter --cov-report=term-missing {posargs}

[testenv:lint]
description = Run pylint code quality checks
deps =
    pylint>=2.17.0
    prometheus-client>=0.17.0
    pyserial>=3.5
    colorlog>=6.9.0
    paho-mqtt>=2.1.0
    pyserial-asyncio-fast>=0.16
    voluptuous>=0.15.2
    asyncio-mqtt>=0.16.0
    requests>=2.25.0
skip_install = False
commands =
    pylint honeywell_radio_exporter/ --max-line-length=100

[testenv:format]
description = Run black code formatter
deps =
    black>=23.0.0
skip_install = True
commands =
    black --line-length 100 honeywell_radio_exporter/ tests/ scripts/

[testenv:format-check]
description = Check code formatting with black
deps =
    black>=23.0.0
skip_install = True
commands =
    black --check --line-length 100 honeywell_radio_exporter/ tests/ scripts/

[testenv:test]
description = Run tests with coverage
deps =
    pytest>=7.0
    pytest-cov>=4.0
    pytest-asyncio>=0.21.0
    prometheus-client>=0.17.0
commands =
    pytest tests/ --cov=honeywell_radio_exporter --cov-report=term-missing --cov-report=html --cov-report=xml {posargs}

[testenv:test-no-cov]
description = Run tests without coverage
deps =
    pytest>=7.0
    pytest-asyncio>=0.21.0
    prometheus-client>=0.17.0
commands =
    pytest tests/ {posargs}

[testenv:all]
description = Run all checks (lint, format-check, tests, docs)
deps =
    {[testenv:lint]deps}
    {[testenv:format-check]deps}
    {[testenv:test]deps}
    {[testenv:markdown]deps}
    {[testenv:yaml]deps}
commands =
    black --check --line-length 100 honeywell_radio_exporter/ tests/ scripts/
    pylint honeywell_radio_exporter/ --max-line-length=100
    pytest tests/ --cov=honeywell_radio_exporter --cov-report=term-missing
    mdformat --check --wrap 100 README.md docs/ scripts/
    yamllint -f colored .

[testenv:dev]
description = Development environment with all tools
deps =
    {[testenv:lint]deps}
    {[testenv:format]deps}
    {[testenv:test]deps}
    ipython
    ipdb
usedevelop = True

[testenv:markdown]
description = Lint markdown files
deps =
    mdformat>=0.7.0
    mdformat-gfm>=0.3.0
    mdformat-black>=0.1.0
skip_install = True
commands =
    mdformat --check --wrap 100 README.md docs/ scripts/

[testenv:markdown-fix]
description = Fix markdown formatting
deps =
    mdformat>=0.7.0
    mdformat-gfm>=0.3.0
    mdformat-black>=0.1.0
skip_install = True
commands =
    mdformat --wrap 100 README.md docs/ scripts/

[testenv:yaml]
description = Lint YAML files
deps =
    yamllint>=1.32.0
skip_install = True
commands =
    yamllint -f colored .

[testenv:docs]
description = Check all documentation (markdown + yaml)
deps =
    {[testenv:markdown]deps}
    {[testenv:yaml]deps}
skip_install = True
commands =
    mdformat --check --wrap 100 README.md docs/ scripts/
    yamllint -f colored .

# Pytest configuration
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = 
    -v
    --strict-markers
    --tb=short
markers =
    slow: marks tests as slow (deselect with '-m "not slow"')
    integration: marks tests as integration tests
    unit: marks tests as unit tests

# Coverage configuration
[coverage:run]
source = honeywell_radio_exporter
omit =
    */tests/*
    */test_*.py
    */__pycache__/*
    */venv/*

[coverage:report]
precision = 2
show_missing = True
skip_covered = False

[coverage:html]
directory = htmlcov

# Note: Black configuration is in pyproject.toml

# Pylint configuration
[pylint]
max-line-length = 100
disable =
    C0114,  # missing-module-docstring
    C0115,  # missing-class-docstring
    C0116,  # missing-function-docstring
    R0902,  # too-many-instance-attributes
    R0913,  # too-many-arguments
    R0914,  # too-many-locals
    W0212,  # protected-access (for _get_device_name etc)
good-names = i,j,k,ex,_,id,msg,src,dst,uid

[pylint.MASTER]
ignore = tests,venv,.tox

[pylint.FORMAT]
max-line-length = 100

[pylint.SIMILARITIES]
min-similarity-lines = 10
ignore-comments = yes
ignore-docstrings = yes
